@page
@model MetalMetrics.Web.Pages.Reports.IndexModel
@{
    ViewData["Title"] = "Reports";
}

<!-- Reporting Period -->
<div class="card shadow-sm mb-4">
    <div class="card-body py-3">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-calendar-range text-muted"></i>
                <span class="fw-semibold">@Model.From.ToString("MMM d, yyyy")</span>
                <span class="text-muted">&ndash;</span>
                <span class="fw-semibold">@Model.To.ToString("MMM d, yyyy")</span>
            </div>
            @if (Model.Jobs.Count > 0)
            {
                <a asp-page="/Reports/Index" asp-page-handler="DownloadPdf" asp-route-from="@Model.From.ToString("yyyy-MM-dd")" asp-route-to="@Model.To.ToString("yyyy-MM-dd")" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-file-earmark-pdf me-1"></i>PDF
                </a>
            }
        </div>
        <div class="d-flex align-items-end gap-2 flex-wrap">
            <div class="btn-group btn-group-sm me-2" role="group">
                <a asp-page="/Reports/Index" asp-route-from="@DateTime.UtcNow.AddDays(-30).ToString("yyyy-MM-dd")" asp-route-to="@DateTime.UtcNow.ToString("yyyy-MM-dd")" class="btn btn-outline-secondary">30 Days</a>
                <a asp-page="/Reports/Index" asp-route-from="@DateTime.UtcNow.AddDays(-90).ToString("yyyy-MM-dd")" asp-route-to="@DateTime.UtcNow.ToString("yyyy-MM-dd")" class="btn btn-outline-secondary">90 Days</a>
                <a asp-page="/Reports/Index" asp-route-from="@DateTime.UtcNow.AddMonths(-6).ToString("yyyy-MM-dd")" asp-route-to="@DateTime.UtcNow.ToString("yyyy-MM-dd")" class="btn btn-outline-secondary">6 Months</a>
                <a asp-page="/Reports/Index" asp-route-from="@(new DateTime(DateTime.UtcNow.Year, 1, 1).ToString("yyyy-MM-dd"))" asp-route-to="@DateTime.UtcNow.ToString("yyyy-MM-dd")" class="btn btn-outline-secondary">YTD</a>
                <a asp-page="/Reports/Index" asp-route-from="@(new DateTime(DateTime.UtcNow.Year - 1, 1, 1).ToString("yyyy-MM-dd"))" asp-route-to="@(new DateTime(DateTime.UtcNow.Year - 1, 12, 31).ToString("yyyy-MM-dd"))" class="btn btn-outline-secondary">Last Year</a>
            </div>
            <form method="get" class="d-flex align-items-end gap-2 mb-0">
                <input type="date" class="form-control form-control-sm" asp-for="From" />
                <input type="date" class="form-control form-control-sm" asp-for="To" />
                <button type="submit" class="btn btn-sm btn-warning fw-semibold">Apply</button>
            </form>
        </div>
    </div>
</div>

<!-- Financial Summary -->
<div class="card shadow-sm mb-4">
    <div class="card-body py-4">
        <div class="text-center mb-3">
            <div class="d-flex justify-content-center align-items-center gap-4 flex-wrap">
                <div>
                    <div class="text-muted small text-uppercase fw-semibold">Revenue</div>
                    <div class="fs-4">@Model.TotalRevenue.ToString("C0")</div>
                </div>
                <div class="text-muted fs-4">&minus;</div>
                <div>
                    <div class="text-muted small text-uppercase fw-semibold">Cost</div>
                    <div class="fs-4">@Model.TotalCost.ToString("C0")</div>
                </div>
                <div class="text-muted fs-4">=</div>
                <div>
                    <div class="text-muted small text-uppercase fw-semibold">Profit</div>
                    <div class="display-5 fw-bold">@((Model.TotalProfit >= 0 ? "+" : "") + Model.TotalProfit.ToString("C0"))</div>
                </div>
            </div>
        </div>
        <hr class="my-3" />
        <div class="row text-center">
            <div class="col-md-4">
                <div class="text-muted small"><i class="bi bi-check2-circle me-1"></i>Jobs Completed</div>
                <div class="fs-5 fw-semibold">@Model.JobCount</div>
            </div>
            <div class="col-md-4">
                <div class="text-muted small"><i class="bi bi-percent me-1"></i>Avg Margin</div>
                <div class="fs-5 fw-semibold">@Model.AvgMargin.ToString("F1")%</div>
            </div>
            <div class="col-md-4">
                <div class="text-muted small"><i class="bi bi-piggy-bank me-1"></i>Profit per Job</div>
                <div class="fs-5 fw-semibold">@((Model.ProfitPerJob >= 0 ? "+" : "") + Model.ProfitPerJob.ToString("C0"))</div>
            </div>
        </div>
    </div>
</div>

@if (Model.Jobs.Count == 0)
{
    <div class="text-center text-muted py-5">
        <p class="lead">No completed jobs in the selected date range.</p>
        <p>Adjust the date range or complete more jobs to see report data.</p>
    </div>
}
else
{
    var bestJob = Model.Jobs.OrderByDescending(j => j.ActualMarginPercent).First();
    var worstJob = Model.Jobs.OrderBy(j => j.ActualMarginPercent).First();
    var profitableCount = Model.Jobs.Count(j => j.IsProfitable);
    var unprofitableCount = Model.Jobs.Count - profitableCount;

    <!-- Best / Worst Margin -->
    <div class="card shadow-sm mb-4">
        <div class="card-body py-3">
            <div class="row">
                <div class="col-md-6 d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-muted small"><i class="bi bi-trophy me-1"></i>Best Margin</div>
                        <div>
                            <a asp-page="/Jobs/Details" asp-route-slug="@bestJob.Slug" class="fw-semibold text-decoration-none">@bestJob.JobNumber</a>
                            <span class="text-muted"> — @bestJob.CustomerName</span>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="fs-5 fw-bold">@bestJob.ActualMarginPercent.ToString("F1")%</div>
                        <div class="small text-muted">@((bestJob.ActualRevenue - bestJob.TotalActualCost) >= 0 ? "+" : "")@((bestJob.ActualRevenue - bestJob.TotalActualCost).ToString("C0"))</div>
                    </div>
                </div>
                <div class="col-md-6 d-flex justify-content-between align-items-center border-start">
                    <div>
                        <div class="text-muted small"><i class="bi bi-arrow-down-circle me-1"></i>Worst Margin</div>
                        <div>
                            <a asp-page="/Jobs/Details" asp-route-slug="@worstJob.Slug" class="fw-semibold text-decoration-none">@worstJob.JobNumber</a>
                            <span class="text-muted"> — @worstJob.CustomerName</span>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="fs-5 fw-bold">@worstJob.ActualMarginPercent.ToString("F1")%</div>
                        <div class="small text-muted">@((worstJob.ActualRevenue - worstJob.TotalActualCost) >= 0 ? "+" : "")@((worstJob.ActualRevenue - worstJob.TotalActualCost).ToString("C0"))</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Breakdown -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-calendar3 me-1"></i>Monthly Breakdown</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0 mm-sortable">
                    <thead class="table-light">
                        <tr>
                            <th class="sortable" data-sort="string" role="button">Month</th>
                            <th class="sortable text-center" data-sort="number" role="button">Jobs</th>
                            <th class="sortable text-end" data-sort="number" role="button">Revenue</th>
                            <th class="sortable text-end" data-sort="number" role="button">Cost</th>
                            <th class="sortable text-end" data-sort="number" role="button">Profit</th>
                            <th class="sortable text-end" data-sort="number" role="button">Margin %</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var monthlyGroups = Model.Jobs
                                .GroupBy(j => new { j.CompletedAt.Year, j.CompletedAt.Month })
                                .OrderBy(g => g.Key.Year).ThenBy(g => g.Key.Month)
                                .ToList();
                        }
                        @foreach (var month in monthlyGroups)
                        {
                            var mRevenue = month.Sum(j => j.ActualRevenue);
                            var mCost = month.Sum(j => j.TotalActualCost);
                            var mProfit = mRevenue - mCost;
                            var mMargin = mRevenue > 0 ? mProfit / mRevenue * 100 : 0;
                            var monthDate = new DateTime(month.Key.Year, month.Key.Month, 1);
                            <tr>
                                <td>@monthDate.ToString("MMM yyyy")</td>
                                <td class="text-center">@month.Count()</td>
                                <td class="text-end">@mRevenue.ToString("C0")</td>
                                <td class="text-end">@mCost.ToString("C0")</td>
                                <td class="text-end @(mProfit >= 0 ? "text-profit" : "text-loss")">
                                    @((mProfit >= 0 ? "+" : "") + mProfit.ToString("C0"))
                                </td>
                                <td class="text-end @(mMargin >= 0 ? "text-profit" : "text-loss")">@mMargin.ToString("F1")%</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="table-light fw-semibold">
                        <tr>
                            <td>Total</td>
                            <td class="text-center">@Model.JobCount</td>
                            <td class="text-end">@Model.TotalRevenue.ToString("C0")</td>
                            <td class="text-end">@Model.TotalCost.ToString("C0")</td>
                            <td class="text-end @(Model.TotalProfit >= 0 ? "text-profit" : "text-loss")">
                                @((Model.TotalProfit >= 0 ? "+" : "") + Model.TotalProfit.ToString("C0"))
                            </td>
                            @{
                                var overallMargin = Model.TotalRevenue > 0 ? Model.TotalProfit / Model.TotalRevenue * 100 : 0;
                            }
                            <td class="text-end">@overallMargin.ToString("F1")%</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Margin Distribution + Profitable vs Unprofitable -->
    <div class="row mb-4">
        <div class="col-md-7">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-bar-chart me-1"></i>Margin Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="marginDistChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-pie-chart me-1"></i>Profitable vs Unprofitable</h5>
                </div>
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                    <canvas id="profitSplitChart"></canvas>
                    <div class="row text-center mt-3 w-100">
                        <div class="col-6">
                            <div class="fs-4 fw-bold text-profit">@profitableCount</div>
                            <div class="small text-muted">profitable</div>
                        </div>
                        <div class="col-6">
                            <div class="fs-4 fw-bold text-loss">@unprofitableCount</div>
                            <div class="small text-muted">unprofitable</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Profitability -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-people me-1"></i>Customer Profitability</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0 mm-sortable">
                            <thead class="table-light">
                                <tr>
                                    <th class="sortable" data-sort="string" role="button">Customer</th>
                                    <th class="sortable text-center" data-sort="number" role="button">Jobs</th>
                                    <th class="sortable text-end" data-sort="number" role="button">Revenue</th>
                                    <th class="sortable text-end" data-sort="number" role="button">P/L</th>
                                    <th class="sortable text-end" data-sort="number" role="button">Margin</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var c in Model.CustomerProfitability)
                                {
                                    <tr>
                                        <td>@c.CustomerName</td>
                                        <td class="text-center">@c.JobCount</td>
                                        <td class="text-end">@c.TotalRevenue.ToString("C0")</td>
                                        <td class="text-end @(c.ProfitLoss >= 0 ? "text-profit" : "text-loss")">
                                            @((c.ProfitLoss >= 0 ? "+" : "") + c.ProfitLoss.ToString("C0"))
                                        </td>
                                        <td class="text-end @(c.MarginPercent >= 0 ? "text-profit" : "text-loss")">
                                            @c.MarginPercent.ToString("F1")%
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-bar-chart-line me-1"></i>Customer Profitability Chart</h5>
                </div>
                <div class="card-body">
                    <canvas id="customerProfitChart"></canvas>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    @if (Model.Jobs.Count > 0)
    {
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
        <script>
            var jobs = @Html.Raw(Model.JobSummariesJson);

            // Margin Distribution — bucket jobs by margin range
            var buckets = { '< 0%': 0, '0–10%': 0, '10–20%': 0, '20–30%': 0, '30%+': 0 };
            jobs.forEach(function (j) {
                var m = j.ActualMarginPercent;
                if (m < 0) buckets['< 0%']++;
                else if (m < 10) buckets['0–10%']++;
                else if (m < 20) buckets['10–20%']++;
                else if (m < 30) buckets['20–30%']++;
                else buckets['30%+']++;
            });
            var bucketLabels = Object.keys(buckets);
            var bucketValues = Object.values(buckets);
            var bucketColors = ['rgba(220, 53, 69, 0.7)', 'rgba(255, 193, 7, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(40, 167, 69, 0.7)', 'rgba(16, 185, 129, 0.7)'];

            new Chart(document.getElementById('marginDistChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: bucketLabels,
                    datasets: [{
                        label: 'Jobs',
                        data: bucketValues,
                        backgroundColor: bucketColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (ctx) {
                                    var count = ctx.raw;
                                    var pct = jobs.length > 0 ? (count / jobs.length * 100).toFixed(0) : 0;
                                    return count + ' job' + (count !== 1 ? 's' : '') + ' (' + pct + '%)';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });

            // Profitable vs Unprofitable donut
            var profitable = jobs.filter(function (j) { return j.IsProfitable; }).length;
            var unprofitable = jobs.length - profitable;

            new Chart(document.getElementById('profitSplitChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Profitable', 'Unprofitable'],
                    datasets: [{
                        data: [profitable, unprofitable],
                        backgroundColor: ['rgba(40, 167, 69, 0.8)', 'rgba(220, 53, 69, 0.8)'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    aspectRatio: 1.5,
                    cutout: '60%',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Customer Profitability horizontal bar chart
            var custData = @Html.Raw(Model.CustomerProfitabilityJson);
            new Chart(document.getElementById('customerProfitChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: custData.map(function (c) { return c.CustomerName; }),
                    datasets: [{
                        label: 'Profit / Loss',
                        data: custData.map(function (c) { return c.ProfitLoss; }),
                        backgroundColor: custData.map(function (c) {
                            return c.ProfitLoss >= 0 ? 'rgba(40, 167, 69, 0.7)' : 'rgba(220, 53, 69, 0.7)';
                        }),
                        borderColor: custData.map(function (c) {
                            return c.ProfitLoss >= 0 ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (ctx) {
                                    var c = custData[ctx.dataIndex];
                                    return 'P/L: $' + c.ProfitLoss.toFixed(0) + ' | Margin: ' + c.MarginPercent.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { callback: function (v) { return '$' + v.toFixed(0); } }
                        }
                    }
                }
            });
        </script>
    }
}
