<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - MetalMetrics</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="~/css/metalmetrics.css" asp-append-version="true" />
</head>
<body>
    @{
        var fullName = User.FindFirst("FullName")?.Value ?? User.Identity?.Name ?? "User";
        var firstName = fullName.Split(' ')[0];
        var initials = string.Join("", fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries).Take(2).Select(n => n[0])).ToUpper();
        var role = User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value ?? "";
        var currentPage = ViewContext.RouteData.Values["page"]?.ToString() ?? "";
    }

    <!-- Sidebar Overlay (mobile) -->
    <div class="mm-sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside class="mm-sidebar" id="sidebar">
        <div class="mm-sidebar-brand">
            <a asp-page="/Index">
                <span class="brand-metal">Metal</span><span class="brand-metrics">Metrics</span>
            </a>
        </div>

        <ul class="mm-sidebar-nav">
            @if (User.IsInRole("Admin") || User.IsInRole("Owner") || User.IsInRole("ProjectManager"))
            {
                <li>
                    <a asp-page="/Dashboard/Index" class="@(currentPage.StartsWith("/Dashboard") ? "active" : "")">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                </li>
            }

            <li>
                <a asp-page="/Jobs/Index" class="@(currentPage.StartsWith("/Jobs") && !currentPage.Contains("Quote") && !currentPage.Contains("Actuals") ? "active" : "")">
                    <i class="bi bi-briefcase"></i> Jobs
                </a>
            </li>

            @if (User.IsInRole("Admin") || User.IsInRole("Owner") || User.IsInRole("ProjectManager") || User.IsInRole("Estimator"))
            {
                <li>
                    <a asp-page="/Jobs/Index" asp-route-StatusFilter="Quoted"
                       class="@(ViewContext.HttpContext.Request.Query["StatusFilter"].ToString() == "Quoted" ? "active" : "")">
                        <i class="bi bi-calculator"></i> Quotes
                    </a>
                </li>
            }

            @if (User.IsInRole("Admin") || User.IsInRole("Owner") || User.IsInRole("ProjectManager") || User.IsInRole("Foreman"))
            {
                <li>
                    <a asp-page="/Jobs/Index" asp-route-StatusFilter="InProgress"
                       class="@(ViewContext.HttpContext.Request.Query["StatusFilter"].ToString() == "InProgress" ? "active" : "")">
                        <i class="bi bi-clipboard-data"></i> Actuals
                    </a>
                </li>
            }

            @if (User.IsInRole("Admin") || User.IsInRole("Owner") || User.IsInRole("ProjectManager"))
            {
                <li>
                    <a asp-page="/Reports/Index" class="@(currentPage.StartsWith("/Reports") ? "active" : "")">
                        <i class="bi bi-bar-chart-line"></i> Reports
                    </a>
                </li>
            }

            @if (User.IsInRole("Admin") || User.IsInRole("Owner"))
            {
                <mm-sidebar-section class="mm-sidebar-section">Management</mm-sidebar-section>
                <li>
                    <a asp-page="/Admin/Users" class="@(currentPage.StartsWith("/Admin") ? "active" : "")">
                        <i class="bi bi-gear"></i> Admin
                    </a>
                </li>
                <li>
                    <a asp-page="/Billing/Portal" class="@(currentPage.StartsWith("/Billing") ? "active" : "")">
                        <i class="bi bi-credit-card"></i> Billing
                    </a>
                </li>
            }

            @if (User.IsInRole("SuperAdmin"))
            {
                <li>
                    <a asp-page="/Dashboard/Index" class="@(currentPage.StartsWith("/Dashboard") ? "active" : "")">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                </li>
                <li>
                    <a asp-page="/Platform/Index" class="@(currentPage.StartsWith("/Platform") ? "active" : "")">
                        <i class="bi bi-building"></i> Platform
                    </a>
                </li>
            }
        </ul>

        <!-- User info + Logout -->
        <div class="mm-sidebar-footer">
            <div class="mm-sidebar-user">
                <div class="mm-sidebar-avatar">@initials</div>
                <div class="mm-sidebar-user-info">
                    <div class="mm-sidebar-user-name">@firstName</div>
                    <div class="mm-sidebar-user-role">@role</div>
                </div>
            </div>
            <form method="post" asp-page="/Logout">
                <button type="submit" class="btn-logout">
                    <i class="bi bi-box-arrow-left"></i> Sign Out
                </button>
            </form>
        </div>
    </aside>

    <!-- Topbar -->
    <header class="mm-topbar">
        <button class="mm-topbar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
            <i class="bi bi-list"></i>
        </button>
        <h1 class="mm-topbar-title">@(ViewData["Title"] ?? "MetalMetrics")</h1>
    </header>

    <!-- Content -->
    <main class="mm-content" role="main">
        <partial name="_Notifications" />

        @if (User.Identity?.IsAuthenticated == true && !User.IsInRole("SuperAdmin"))
        {
            var subStatus = User.FindFirst("SubscriptionStatus")?.Value;
            if (subStatus == "Trial")
            {
                var trialEndStr = User.FindFirst("TrialEndsAt")?.Value;
                var daysLeft = 0;
                if (DateTime.TryParse(trialEndStr, out var trialEnd))
                {
                    daysLeft = Math.Max(0, (int)(trialEnd - DateTime.UtcNow).TotalDays);
                }
                <div class="alert alert-warning text-center mb-3 mm-sub-banner">
                    Your trial expires in <strong>@daysLeft day@(daysLeft != 1 ? "s" : "")</strong>.
                    <a asp-page="/Billing/Subscribe" class="alert-link ms-1">Subscribe now</a>
                </div>
            }
            else if (subStatus == "PastDue")
            {
                <div class="alert alert-danger text-center mb-3 mm-sub-banner">
                    Payment failed. <a asp-page="/Billing/Portal" class="alert-link">Update billing</a> to avoid service interruption.
                </div>
            }
        }

        @RenderBody()
    </main>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
