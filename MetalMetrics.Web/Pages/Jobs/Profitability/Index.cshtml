@page "{slug}"
@model MetalMetrics.Web.Pages.Jobs.Profitability.IndexModel
@{
    ViewData["Title"] = $"Profitability — {Model.Job.JobNumber}";
}

<h2>Profitability — @Model.Job.JobNumber</h2>
<p class="text-muted">Customer: @Model.Job.CustomerName</p>

@if (!Model.HasActuals)
{
    <div class="alert alert-info">
        <strong>Actuals not entered.</strong> Enter actual costs to see the profitability analysis.
        <a asp-page="/Jobs/Actuals/Enter" asp-route-slug="@Model.Job.Slug" class="alert-link ms-2">Enter Actuals</a>
    </div>
    <a asp-page="/Jobs/Details" asp-route-slug="@Model.Job.Slug" class="btn btn-outline-secondary">Back to Job</a>
}
else if (Model.Report != null)
{
    var r = Model.Report;
    var verdictClass = r.OverallVerdict == "Profit" ? "bg-profit" : (r.OverallVerdict == "Loss" ? "bg-loss" : "bg-secondary");
    var verdictSign = r.OverallVerdict == "Profit" ? "+" : (r.OverallVerdict == "Loss" ? "-" : "");

    <div class="card shadow-sm mb-4 @verdictClass text-white">
        <div class="card-body text-center py-4">
            <h3 class="mb-1">
                @r.OverallVerdict.ToUpper()
                @(verdictSign)@Math.Abs(r.ActualMarginDollars).ToString("C")
            </h3>
            <p class="mb-0">Actual Margin: @r.ActualMarginPercent.ToString("F1")%</p>
        </div>
    </div>

    @if (r.Warnings.Count > 0)
    {
        <div class="mb-4">
            @foreach (var warning in r.Warnings)
            {
                <div class="alert alert-warning py-2 mb-1">@warning</div>
            }
        </div>
    }

    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Estimated vs Actual Cost</h5>
                </div>
                <div class="card-body">
                    <canvas id="varianceChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Detailed Breakdown</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Category</th>
                                    <th class="text-end">Estimated</th>
                                    <th class="text-end">Actual</th>
                                    <th class="text-end">Var ($)</th>
                                    <th class="text-end">Var (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    var categories = new[]
                                    {
                                        ("Labor", r.LaborVariance),
                                        ("Material", r.MaterialVariance),
                                        ("Machine", r.MachineVariance),
                                        ("Overhead", r.OverheadVariance)
                                    };
                                }
                                @foreach (var (name, v) in categories)
                                {
                                    var varClass = v.VarianceDollars > 0 ? "text-loss" : (v.VarianceDollars < 0 ? "text-profit" : "");
                                    <tr>
                                        <td>@name</td>
                                        <td class="text-end">@v.EstimatedAmount.ToString("C")</td>
                                        <td class="text-end">@v.ActualAmount.ToString("C")</td>
                                        <td class="text-end @varClass">@((v.VarianceDollars >= 0 ? "+" : "") + v.VarianceDollars.ToString("C"))</td>
                                        <td class="text-end @varClass">@((v.VariancePercent >= 0 ? "+" : "")+ v.VariancePercent.ToString("F1"))%</td>
                                    </tr>
                                }
                                <tr class="fw-bold table-secondary">
                                    <td>Total</td>
                                    <td class="text-end">@r.TotalEstimatedCost.ToString("C")</td>
                                    <td class="text-end">@r.TotalActualCost.ToString("C")</td>
                                    @{
                                        var totalVar = r.TotalActualCost - r.TotalEstimatedCost;
                                        var totalVarPct = r.TotalEstimatedCost != 0 ? totalVar / r.TotalEstimatedCost * 100 : 0;
                                        var totalVarClass = totalVar > 0 ? "text-loss" : (totalVar < 0 ? "text-profit" : "");
                                    }
                                    <td class="text-end @totalVarClass">@((totalVar >= 0 ? "+" : "") + totalVar.ToString("C"))</td>
                                    <td class="text-end @totalVarClass">@((totalVarPct >= 0 ? "+" : "") + totalVarPct.ToString("F1"))%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">Margin Analysis</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 text-center">
                    <small class="text-muted d-block">Quote Price</small>
                    <strong>@r.QuotedPrice.ToString("C")</strong>
                </div>
                <div class="col-md-3 text-center">
                    <small class="text-muted d-block">Actual Revenue</small>
                    <strong>@r.ActualRevenue.ToString("C")</strong>
                </div>
                <div class="col-md-3 text-center">
                    <small class="text-muted d-block">Est. Margin</small>
                    <strong>@r.EstimatedMarginPercent.ToString("F1")%</strong>
                </div>
                <div class="col-md-3 text-center">
                    <small class="text-muted d-block">Margin Drift</small>
                    <strong class="@(r.MarginDriftPercent < 0 ? "text-loss" : "text-profit")">
                        @((r.MarginDriftPercent >= 0 ? "+" : "") + r.MarginDriftPercent.ToString("F1")) pts
                    </strong>
                </div>
            </div>
        </div>
    </div>

    <a asp-page="/Jobs/Details" asp-route-slug="@Model.Job.Slug" class="btn btn-outline-secondary">Back to Job</a>
}

@section Scripts {
    @if (Model.Report != null)
    {
        var r = Model.Report;
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
        <script>
            var ctx = document.getElementById('varianceChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Labor', 'Material', 'Machine', 'Overhead'],
                    datasets: [
                        {
                            label: 'Estimated',
                            data: [@r.LaborVariance.EstimatedAmount, @r.MaterialVariance.EstimatedAmount, @r.MachineVariance.EstimatedAmount, @r.OverheadVariance.EstimatedAmount],
                            backgroundColor: 'rgba(54, 162, 235, 0.7)'
                        },
                        {
                            label: 'Actual',
                            data: [@r.LaborVariance.ActualAmount, @r.MaterialVariance.ActualAmount, @r.MachineVariance.ActualAmount, @r.OverheadVariance.ActualAmount],
                            backgroundColor: [
                                @(r.LaborVariance.VarianceDollars > 0 ? "'rgba(220, 53, 69, 0.7)'" : "'rgba(40, 167, 69, 0.7)'"),
                                @(r.MaterialVariance.VarianceDollars > 0 ? "'rgba(220, 53, 69, 0.7)'" : "'rgba(40, 167, 69, 0.7)'"),
                                @(r.MachineVariance.VarianceDollars > 0 ? "'rgba(220, 53, 69, 0.7)'" : "'rgba(40, 167, 69, 0.7)'"),
                                @(r.OverheadVariance.VarianceDollars > 0 ? "'rgba(220, 53, 69, 0.7)'" : "'rgba(40, 167, 69, 0.7)'")
                            ]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) { return '$' + value.toFixed(0); }
                            }
                        }
                    }
                }
            });
        </script>
    }
}
